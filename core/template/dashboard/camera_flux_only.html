<div class="camera" data-camera_uid="#uid#" data-camera_id="#id#" style="width: 100%;height: 100%">
  <span class="directDisplay" style="width: 100%;height: 100%"><img src="plugins/camera/core/img/no-image-blanc.png" style="width: 100%;height: 100%" data-camera_id="#id#"/></span>
  <div class="md_cameraZoom" data-camera_uid="#uid#" data-camera_id="#id#" title="#name_display#">
    <center>
      <div class="display"><img src="plugins/camera/core/img/no-image-noir.png" class="img-responsive" data-camera_id="#id#" /></div>
      <br/>
      #action#
      <span class="cmd cmd-widget" data-type="action" data-subtype="other">
        <a class="camera_history btn btn-default btn-sm folder action" data-camera_id="#id#"><i class="fa fa-folder-open"></i></a>
      </span>
    </center>
  </div>
  <script>
    if ($(".md_cameraZoom[data-camera_uid=#uid#]").length > 1) {
      while ($(".md_cameraZoom[data-camera_uid=#uid#]").length > 1) {
        $(".md_cameraZoom[data-camera_uid=#uid#]").eq(0).remove();
      }
    }
    $('.camera[data-camera_id=#id#] .directDisplay img').css('max-height',$('.camera[data-camera_id=#id#]').height());
    $('.camera[data-camera_id=#id#] .directDisplay img').css('max-width',$('.camera[data-camera_id=#id#]').width());
    $('.camera[data-camera_id=#id#]').off('resize').on('resize',function(){
      $('.camera[data-camera_id=#id#] .directDisplay img').css('max-height',$('.camera[data-camera_id=#id#]').height());
      $('.camera[data-camera_id=#id#] .directDisplay img').css('max-width',$('.camera[data-camera_id=#id#]').width());
    });
    $('.camera_history[data-camera_id=#id#]').off().on('click', function () {
      $('#md_modal').dialog({title: "Historique #name#"});
      $('#md_modal').load('index.php?v=d&plugin=camera&modal=camera.history&id=#id#').dialog('open');
    });
    $(".md_cameraZoom[data-camera_id=#id#]").dialog({
      autoOpen: false,
      modal: true,
      resizable: false,
      closeText: '',
      height: jQuery(window).height() - 65,
      width: jQuery(window).width() - 40,
      position: { my: "center bottom-10", at: "center bottom", of: window },
      open: function () {
        $("body").css({overflow: 'hidden'});
        $(".md_cameraZoom[data-camera_uid=#uid#] .display img").height($(".md_cameraZoom[data-camera_uid=#uid#]").height() -50);
        if (typeof timeoutCamera#id# !== "undefined") {
          clearTimeout(timeoutCamera#id#);
        }
        refreshImgCam#id#();
      },
      beforeClose: function (event, ui) {
        $("body").css({overflow: 'inherit'});
      }
    });
    $('.camera[data-camera_id=#id#]').undelegate('.zoom', 'click').delegate('.zoom', 'click', function () {
      $(".md_cameraZoom[data-camera_uid=#uid#]").dialog("open");
    });
    maxWidth_#id#_thumbnail = 0;
    maxWidth_#id# = 0;
    function refreshImgCam#id#(){
      if($('.camera[data-camera_uid=#uid#]').html() == undefined){
        return;
      }
      if(!$(".md_cameraZoom[data-camera_uid=#uid#]").is(':visible') && $(".md_cameraZoom").is(':visible')){
        timeoutCamera#id# =  setTimeout(refreshImgCam#id#,#refreshDelaySlow#);
        return;
      }
      var thumbnail = !$(".md_cameraZoom[data-camera_uid=#uid#]").is(':visible');
      var start = Date.now();
      var url = "#url#";
      url += (url.indexOf('?') > 0) ? '&t='+(new Date()).getTime() : '?t='+(new Date()).getTime();
      if(maxWidth_#id#_thumbnail < $('.camera[data-camera_id=#id#] .directDisplay img').css('max-width').replace('px','')){
        maxWidth_#id#_thumbnail = $('.camera[data-camera_id=#id#] .directDisplay img').css('max-width').replace('px','');
      }
      if(maxWidth_#id# < $(".md_cameraZoom[data-camera_id=#id#] .display img").width()){
        maxWidth_#id# = $(".md_cameraZoom[data-camera_id=#id#] .display img").width();
      }
      url += (thumbnail) ? '&thumbnail=1&width='+ maxWidth_#id#_thumbnail:'&width='+maxWidth_#id#;
      var img = new Image();
      img.src = url;
      img.onload = function() {
        if(thumbnail){
          $('.camera[data-camera_id=#id#] .directDisplay img').attr('src',img.src);
          $('.camera[data-camera_id=#id#] .directDisplay img').attr('data-imgready',1);
        }else{
          $(".camera[data-camera_id=#id#] .display img").attr('src',img.src);
        }
        var delay = (thumbnail) ? #refreshDelaySlow# - (Date.now() - start) :  #refreshDelayFast# - (Date.now() - start);
        timeoutCamera#id# =  setTimeout(refreshImgCam#id#,delay);
      }
      img.onerror = function() {
        $('.camera[data-camera_id=#id#] .directDisplay img').attr('src','plugins/camera/core/img/no-image-blanc.png');
        if($('.camera[data-camera_uid=#uid#]').html() != undefined){
          timeoutCamera#id# = setTimeout(refreshImgCam#id#, #refreshDelaySlow# * 2);
        }
      }
    }
    if (typeof timeoutCamera#id# !== "undefined") {
      clearTimeout(timeoutCamera#id#);
    }
    refreshImgCam#id#();
  </script>
</div>
